<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Post</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header
        style="display: flex; flex-direction: column; align-items: center; background: #35424a; color: #fff; padding: 10px 0;">
        <div style="text-align: center; width: 100%; margin-bottom: 15px;">
            <h1 style="margin: 0;">Blog de Avaliações</h1>
        </div>
        <div class="search-box"
            style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px; width: 100%;">
            <input type="text" placeholder="Pesquisar títulos e resumos..." id="searchBox" style="width: 200px; padding: 8px;">
            <button onclick="realizarBusca()"
                style="margin-left: 8px; padding: 8px 16px; background: #5cb85c; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Pesquisar</button>
            <button onclick="limparBusca()"
                style="margin-left: 8px; padding: 8px 16px; background: #6c757d; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Limpar</button>
        </div>
        <nav style="width: 100%; display: flex; justify-content: center;">
            <ul style="list-style: none; margin: 0; padding: 0; display: flex;">
                <li style="margin: 0 15px;"><a href="index.html" style="color: #fff;">Home</a></li>
                <li style="margin: 0 15px;"><a href="#" onclick="filtrarPorCategoria(1)"
                        style="color: #fff; cursor: pointer;">Mangas</a></li>
                <li style="margin: 0 15px;"><a href="#" onclick="filtrarPorCategoria(3)"
                        style="color: #fff; cursor: pointer;">Livros</a></li>
                <li style="margin: 0 15px;"><a href="#" onclick="filtrarPorCategoria(2)"
                        style="color: #fff; cursor: pointer;">Filmes</a></li>
                <li style="margin: 0 15px;"><a href="#" onclick="filtrarPorCategoria(4)"
                        style="color: #fff; cursor: pointer;">Séries</a></li>
                <li style="margin: 0 15px;"><a href="#" onclick="filtrarPorCategoria(5)"
                        style="color: #fff; cursor: pointer;">Cursos</a></li>
                <li style="margin: 0 15px;" id="createPostLink"><a href="admin.html" style="color: #fff;">Criar Post</a>
                </li>
                <li style="margin: 0 15px;" id="authLink"><a href="login.html" style="color: #fff;">Logar</a></li>
            </ul>
        </nav>
    </header>
    <main style="text-align: center;">
        <article style="display: inline-block; text-align: center; max-width: 800px; margin: 20px auto;">
            <h2 id="post-title" style="text-align: center;">Título do Post</h2>
            <img id="post-image" src="../public/img/exemplo.jpg" alt="Imagem do Post" style="width: 100%; max-width: 600px; height: 432px; object-fit: contain; border-radius: 5px; margin: 20px 0;">
            <p id="post-summary" style="text-align: justify; margin: 20px 0;">Resumo do post aqui...</p>
            <p style="text-align: center;"><strong>Avaliação:</strong> <span id="post-rating">★★★★☆</span></p>
            <p id="texto-lido-ate" style="text-align: center;"><strong>Lido até:</strong> <span id="post-lido-ate">N/A</span></p>
            <p style="text-align: center;"><strong>Data do Post:</strong> <span id="post-date">01/01/2023</span></p>
            <p style="text-align: center;"><strong>Categoria:</strong> <span id="post-category">Mangas</span></p>
            <div style="text-align: center; margin-top: 30px;">
                <button id="editPostBtn" style="display: inline-block; padding: 12px 24px; background: #007bff; color: #fff; text-decoration: none; border-radius: 5px; border: none; cursor: pointer; font-size: 16px;">Editar Post</button>
            </div>
        </article>
    </main>
    <footer>
        <p><a href="#">Blog de Avaliações</a></p>
    </footer>

    <script>
        // Variáveis globais para paginação e busca
        let paginaAtual = 1;
        let totalPaginas = 1;
        let filtroCategoria = null;
        let termoBusca = '';

        // Função para obter o ID do post da URL
        function getPostIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Função para obter o texto da marca baseado na categoria
        function obterTextoMarca(categoryId) {
            if (categoryId === 1 || categoryId === 3) {
                return "Lido até:";
            } else if (categoryId === 2 || categoryId === 4) {
                return "Visto até:";
            } else if (categoryId === 5) {
                return "Feito até:";
            } else {
                return "Até:";
            }
        }

        // Função para carregar os detalhes do post
        async function loadPostDetails() {
            const postId = getPostIdFromUrl();
            if (!postId) {
                document.getElementById('post-title').textContent = 'Post não encontrado';
                return;
            }

            try {
                const response = await fetch(`/posts/${postId}`);
                if (!response.ok) {
                    throw new Error('Erro ao buscar post');
                }
                const post = await response.json();

                // Preencher os elementos com os dados do post
                document.getElementById('post-title').textContent = post.titulo;
                document.getElementById('post-image').src = post.imagem || '../public/img/exemplo.jpg';
                document.getElementById('post-summary').textContent = post.resumo;
                document.getElementById('post-rating').textContent = '★'.repeat(post.avaliacao) + '☆'.repeat(5 - post.avaliacao);
                document.getElementById('post-date').textContent = new Date(post.data_post).toLocaleDateString('pt-BR');
                document.getElementById('post-lido-ate').textContent = post.lido_ate || 'N/A';
                document.getElementById('post-category').textContent = post.Category ? post.Category.name : 'N/A';

                // Atualizar o texto da marca baseado na categoria
                const textoMarcaElement = document.getElementById('texto-lido-ate');
                const textoMarca = obterTextoMarca(post.Category ? post.Category.id : 0);
                textoMarcaElement.innerHTML = `<strong>${textoMarca}</strong> <span id="post-lido-ate">${post.lido_ate || 'N/A'}</span>`;
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('post-title').textContent = 'Erro ao carregar post';
            }
        }

        // Função para verificar se usuário está logado
        async function checkLoginStatus() {
            try {
                const response = await fetch('/auth/check');
                const data = await response.json();
                return data.loggedIn;
            } catch (error) {
                console.error('Erro ao verificar status de login:', error);
                return false;
            }
        }

        // Função para fazer logout
        async function logout() {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST'
                });
                if (response.ok) {
                    // Recarregar a página para atualizar o estado
                    window.location.reload();
                } else {
                    alert('Erro ao fazer logout');
                }
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                alert('Erro ao fazer logout');
            }
        }

        // Função para filtrar posts por categoria
        async function filtrarPorCategoria(categoryId) {
            // Redirecionar para a página inicial com filtro
            window.location.href = `index.html?category=${categoryId}`;
        }

        // Função para realizar busca
        async function realizarBusca() {
            const searchInput = document.getElementById('searchBox');
            const searchTerm = searchInput.value.trim();

            if (searchTerm) {
                // Redirecionar para a página inicial com busca
                window.location.href = `index.html?search=${encodeURIComponent(searchTerm)}`;
            }
        }

        // Função para limpar busca
        function limparBusca() {
            const searchInput = document.getElementById('searchBox');
            searchInput.value = '';
            // Redirecionar para a página inicial
            window.location.href = 'index.html';
        }

        // Função para atualizar o link de autenticação
        async function atualizarAuthLink() {
            const authLinkContainer = document.getElementById('authLink');
            const createPostLink = document.getElementById('createPostLink');
            const isLoggedIn = await checkLoginStatus();

            if (isLoggedIn) {
                // Usuário logado - mostrar botão de logout e link de criar post
                authLinkContainer.innerHTML = '<button onclick="logout()" style="background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Deslogar</button>';
                createPostLink.style.display = 'block';
            } else {
                // Usuário não logado - mostrar link de login e esconder criar post
                authLinkContainer.innerHTML = '<a href="login.html" style="color: #fff;">Logar</a>';
                createPostLink.style.display = 'none';
            }
        }

        // Carregar os detalhes do post ao carregar a página
        document.addEventListener('DOMContentLoaded', async function() {
            loadPostDetails();

            // Verificar status de login e mostrar/esconder botão editar
            const isLoggedIn = await checkLoginStatus();
            const editBtn = document.getElementById('editPostBtn');
            if (isLoggedIn) {
                editBtn.style.display = 'inline-block';
                // Adicionar funcionalidade ao botão editar
                editBtn.addEventListener('click', function() {
                    const postId = getPostIdFromUrl();
                    if (postId) {
                        window.location.href = `/admin.html?edit=${postId}`;
                    }
                });
            } else {
                editBtn.style.display = 'none';
            }

            // Atualizar o link de autenticação
            atualizarAuthLink();

            // Adicionar event listener para busca com Enter
            const searchInput = document.getElementById('searchBox');
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    realizarBusca();
                }
            });
        });
    </script>
</body>
</html>
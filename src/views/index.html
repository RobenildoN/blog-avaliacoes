<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog de Avaliações</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        @media (max-width: 470px) {
            header nav ul {
                flex-direction: column;
                align-items: center;
            }

            header nav li {
                margin: 5px 0;
            }

            .search-box {
                flex-direction: column;
                align-items: center;
            }

            .search-box input,
            .search-box button {
                margin-bottom: 5px;
            }
        }
    </style>
</head>

<body>
    <header
        style="display: flex; flex-direction: column; align-items: center; background: #35424a; color: #fff; padding: 10px 0;">
        <div style="text-align: center; width: 100%; margin-bottom: 15px;">
            <h1 style="margin: 0;">Blog de Avaliações</h1>
        </div>
        <div class="search-box"
            style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px; width: 100%;">
            <input type="text" placeholder="Pesquisar títulos e resumos..." id="searchBox"
                style="width: 200px; padding: 8px;">
            <button onclick="realizarBusca()"
                style="margin-left: 8px; padding: 8px 16px; background: #5cb85c; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Pesquisar</button>
            <button onclick="limparBusca()"
                style="margin-left: 8px; padding: 8px 16px; background: #6c757d; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Limpar</button>
        </div>
        <nav style="width: 100%; display: flex; justify-content: center;">
            <ul style="list-style: none; margin: 0; padding: 0; display: flex;">
                <li style="margin: 0 15px;"><a class="nav-link" href="#" onclick="filtrarPorCategoria(1)">Mangas</a>
                </li>
                <li style="margin: 0 15px;"><a class="nav-link" href="#" onclick="filtrarPorCategoria(3)">Livros</a>
                </li>
                <li style="margin: 0 15px;"><a class="nav-link" href="#" onclick="filtrarPorCategoria(2)">Filmes</a>
                </li>
                <li style="margin: 0 15px;"><a class="nav-link" href="#" onclick="filtrarPorCategoria(4)">Séries</a>
                </li>
                <li style="margin: 0 15px;"><a class="nav-link" href="#" onclick="filtrarPorCategoria(5)">Cursos</a>
                </li>
                <li style="margin: 0 15px;" id="createPostLink"><a class="nav-link" href="admin.html">Criar Post</a>
                </li>
                <li style="margin: 0 15px;" id="authLink"><a class="nav-link" href="login.html">Logar</a></li>
            </ul>
        </nav>
    </header>
    <main style="padding-top: 0;">
        <section id="latestPosts">
            <div style="text-align: center; width: 100%; margin-bottom: 15px;">
                <h2>Últimos Posts</h2>
                <button id="showAllBtn" onclick="mostrarTodosPosts()"
                    style="display: none; margin-top: 10px; padding: 8px 16px; background: #28a745; color: #fff; border: none; border-radius: 5px; cursor: pointer;">Mostrar
                    Todos</button>
            </div>
            <div id="postsContainer" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
                <!-- Posts serão carregados dinamicamente aqui -->
                <div class="loading" style="text-align: center; width: 100%;">Carregando posts...</div>
            </div>

            <!-- Controles de paginação -->
            <div id="paginationControls" style="display: none; text-align: center; margin-top: 30px;">
                <button id="prevPageBtn" onclick="mudarPagina(-1)"
                    style="padding: 10px 20px; margin: 0 10px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Anterior</button>
                <span id="pageInfo" style="margin: 0 20px; font-weight: bold;"></span>
                <button id="nextPageBtn" onclick="mudarPagina(1)"
                    style="padding: 10px 20px; margin: 0 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Próximo</button>
            </div>
        </section>
    </main>
    <footer style="height: 30px; padding: 5px 0; text-align: center;">
        <p style="margin: 0;"><a href="#">Blog de Avaliações</a></p>
    </footer>
    <script src="/js/script.js"></script>
    <script>
        // Variáveis globais para paginação e busca
        let paginaAtual = 1;
        let totalPaginas = 1;
        let filtroCategoria = null;
        let termoBusca = '';

        // Função para limitar texto a aproximadamente 5 linhas
        function limitarTexto(texto, maxCaracteres = 180) {
            if (texto.length <= maxCaracteres) {
                return texto;
            }
            // Cortar no limite e encontrar a última palavra completa
            let textoCortado = texto.substring(0, maxCaracteres);
            let ultimaPalavra = textoCortado.lastIndexOf(' ');

            if (ultimaPalavra > 0) {
                textoCortado = textoCortado.substring(0, ultimaPalavra);
            }

            return textoCortado + '...';
        }

        // Função para verificar se usuário está logado
        async function verificarLogin() {
            try {
                const response = await fetch('/auth/check');
                const data = await response.json();
                return data.loggedIn;
            } catch (error) {
                console.error('Erro ao verificar login:', error);
                return false;
            }
        }

        // Função para fazer logout
        async function logout() {
            try {
                const response = await fetch('/auth/logout', {
                    method: 'POST'
                });
                if (response.ok) {
                    // Recarregar a página para atualizar o estado
                    window.location.reload();
                } else {
                    alert('Erro ao fazer logout');
                }
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                alert('Erro ao fazer logout');
            }
        }

        // Função para carregar posts com paginação e busca
        async function carregarPosts(page = 1, categoryId = null, searchTerm = '') {
            try {
                const postsContainer = document.getElementById('postsContainer');
                postsContainer.innerHTML = '<div class="loading" style="text-align: center; width: 100%;">Carregando posts...</div>';

                let url = `/posts?page=${page}&limit=16`;
                if (categoryId) {
                    url = `/posts/category/${categoryId}?page=${page}&limit=16`;
                } else if (searchTerm.trim()) {
                    url = `/posts/search?q=${encodeURIComponent(searchTerm)}&page=${page}&limit=16`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Erro ao buscar posts');
                }

                const data = await response.json();
                const posts = data.posts || data;
                const pagination = data.pagination || { currentPage: 1, totalPages: 1, hasNextPage: false, hasPrevPage: false };

                // Atualizar variáveis globais
                paginaAtual = pagination.currentPage;
                totalPaginas = pagination.totalPages;
                filtroCategoria = categoryId;
                termoBusca = searchTerm;

                // Renderizar posts
                renderizarPosts(posts);

                // Atualizar controles de paginação
                atualizarControlesPaginacao(pagination);

                // Atualizar título da página
                atualizarTitulo(searchTerm, categoryId);

            } catch (error) {
                console.error('Erro ao carregar posts:', error);
                const postsContainer = document.getElementById('postsContainer');
                postsContainer.innerHTML = `<div style="text-align: center; width: 100%; color: red;">Erro ao carregar posts: ${error.message}</div>`;
            }
        }

        // Função para atualizar controles de paginação
        function atualizarControlesPaginacao(pagination) {
            const paginationControls = document.getElementById('paginationControls');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');

            if (pagination.totalPages > 1) {
                paginationControls.style.display = 'block';
                pageInfo.textContent = `Página ${pagination.currentPage} de ${pagination.totalPages}`;

                prevBtn.disabled = !pagination.hasPrevPage;
                prevBtn.style.opacity = pagination.hasPrevPage ? '1' : '0.5';

                nextBtn.disabled = !pagination.hasNextPage;
                nextBtn.style.opacity = pagination.hasNextPage ? '1' : '0.5';
            } else {
                paginationControls.style.display = 'none';
            }
        }
        // Função para obter o texto da marca baseado na categoria
        function obterTextoMarca(categoryId) {
            if (categoryId === 1 || categoryId === 3) {
                return "Lido até:";
            } else if (categoryId === 2 || categoryId === 4) {
                return "Visto até:";
            } else if (categoryId === 5) {
                return "Feito até:";
            } else {
                return "Até:";
            }
        }

        // Função para atualizar o título da página
        function atualizarTitulo(searchTerm, categoryId) {
            const titleElement = document.querySelector('#latestPosts h2');

            if (searchTerm.trim()) {
                titleElement.textContent = `Resultados para "${searchTerm}"`;
            } else if (categoryId) {
                titleElement.textContent = 'Posts da Categoria';
            } else {
                titleElement.textContent = 'Últimos Posts';
            }
        }

        // Função para mudar de página
        function mudarPagina(direcao) {
            const novaPagina = paginaAtual + direcao;
            if (novaPagina >= 1 && novaPagina <= totalPaginas) {
                carregarPosts(novaPagina, filtroCategoria);
            }
        }

        // Função para atualizar os links baseado no status de login
        async function atualizarAuthLink() {
            const authLinkContainer = document.getElementById('authLink');
            const createPostLink = document.getElementById('createPostLink');
            const isLoggedIn = await verificarLogin();

            if (isLoggedIn) {
                authLinkContainer.innerHTML = '<a class="nav-link" href="#" onclick="logout()">Deslogar</a>';
                createPostLink.style.display = 'block';
            } else {
                authLinkContainer.innerHTML = '<a class="nav-link" href="login.html">Logar</a>';
                createPostLink.style.display = 'none';
            }
        }

        // Função para filtrar posts por categoria
        async function filtrarPorCategoria(categoryId) {
            // Resetar para primeira página quando filtrar
            paginaAtual = 1;
            termoBusca = ''; // Limpar termo de busca
            await carregarPosts(1, categoryId, '');

            // Mostrar botão "Mostrar Todos"
            document.getElementById('showAllBtn').style.display = 'inline-block';
        }

        // Função para mostrar todos os posts
        async function mostrarTodosPosts() {
            // Resetar filtro, busca e página
            filtroCategoria = null;
            termoBusca = '';
            paginaAtual = 1;
            await carregarPosts(1, null, '');

            // Esconder botão "Mostrar Todos"
            document.getElementById('showAllBtn').style.display = 'none';
        }

        // Função para realizar busca
        async function realizarBusca() {
            const searchInput = document.getElementById('searchBox');
            const searchTerm = searchInput.value.trim();

            if (searchTerm) {
                // Resetar filtros e página
                filtroCategoria = null;
                paginaAtual = 1;
                termoBusca = searchTerm;

                await carregarPosts(1, null, searchTerm);

                // Esconder botão "Mostrar Todos" durante busca
                document.getElementById('showAllBtn').style.display = 'none';
            } else {
                // Se busca estiver vazia, mostrar todos os posts
                mostrarTodosPosts();
            }
        }

        // Função para limpar busca
        function limparBusca() {
            const searchInput = document.getElementById('searchBox');
            searchInput.value = '';
            mostrarTodosPosts();
        }

        // Função para renderizar posts
        function renderizarPosts(posts) {
            const postsContainer = document.getElementById('postsContainer');

            if (posts.length === 0) {
                postsContainer.innerHTML = '<div style="text-align: center; width: 100%;">Nenhum post encontrado nesta categoria.</div>';
                return;
            }

            postsContainer.innerHTML = posts.map(post => `
                <div class="post" style="width: 300px; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <img src="${post.imagem || '../public/img/exemplo.jpg'}" alt="${post.titulo}" style="width: 100%; height: 300px; object-fit: contain; border-radius: 5px;">
                    <h3 style="margin: 10px 0; text-align: center;">${post.titulo}</h3>
                    <p style="text-align: justify;">${limitarTexto(post.resumo)}</p>
                    <p style="text-align: center;">Avaliação: ${'★'.repeat(post.avaliacao)}${'☆'.repeat(5 - post.avaliacao)}</p>
                    <p style="text-align: center;"><strong>Categoria:</strong> ${post.Category ? post.Category.name : 'N/A'}</p>
                    <p style="text-align: center;"><strong>${obterTextoMarca(post.Category ? post.Category.id : 0)}</strong> ${post.lido_ate || 'N/A'}</p>

                    <div style="text-align: center;">
                        <a href="/post.html?id=${post.id}" style="display: inline-block; padding: 8px 16px; background: #5cb85c; color: #fff; text-decoration: none; border-radius: 5px; margin-top: 10px;">Ler mais</a>
                    </div>
                </div>
            `).join('');
        }

        // Executar quando a página carregar
        document.addEventListener('DOMContentLoaded', function () {
            atualizarAuthLink();
            // Carregar primeira página de posts
            carregarPosts(1, null, '');

            // Adicionar event listener para busca com Enter
            const searchInput = document.getElementById('searchBox');
            searchInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    realizarBusca();
                }
            });
        });
    </script>
</body>

</html>